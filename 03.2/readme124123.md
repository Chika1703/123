# Отчёт по домашнему заданию «Управляющие конструкции в коде Terraform»

**Студент:** *Колб Дмитрий*  
**Версия Terraform:** *~> 1.8.4*  
**Облако:** *timeweb.cloud*

---

## Содержание

- [Введение](#введение)
- [Описание проекта](#описание-проекта)
- [Структура репозитория и конфигурационные файлы](#структура-репозитория-и-конфигурационные-файлы)
  - [count-vm.tf](#count-vmtf)
  - [for_each-vm.tf](#for_each-vmtf)
  - [disk_vm.tf](#disk_vmtf)
  - [ansible.tf](#ansibletf)
  - [variables.tf и terraform.tfvars](#variablestf-и-terraformtfvars)
- [Скриншоты](#скриншоты)
- [Заключение](#заключение)

---

## Введение

Целью данного задания было закрепление навыков работы с управляющими конструкциями в Terraform: `count`, `for_each`, `dynamic`, а также освоение шаблонов и функций `file`, `templatefile`. Все задачи выполнялись в timeweb.cloud.

---

## Описание проекта

Реализованы следующие задачи:

- Создание двух одинаковых веб-серверов с помощью `count`.
- Создание двух разных по конфигурации ВМ для баз данных с `for_each`.
- Установка зависимостей между ресурсами через `depends_on`.
- Использование функции `file()` для подключения SSH-ключа.
- Создание 3 дополнительных дисков и подключение их к ВМ с помощью `dynamic`.
- Генерация ansible-инвентаря с использованием шаблона и `templatefile`.

---

## Структура репозитория и конфигурационные файлы

### count-vm.tf

Создание двух **одинаковых** ВМ web-1 и web-2:

```hcl
resource "yandex_compute_instance" "web" {
  count = 2
  name  = "web-${count.index + 1}"
  ...
  scheduling_policy {
    preemptible = true
  }
  resources {
    core_fraction = 5
  }
  ...
  network_interface {
    ...
    security_group_ids = [yandex_vpc_security_group.sg_web.id]
  }
  metadata = {
    ssh-keys = "ubuntu:${file("~/.ssh/id_rsa.pub")}"
  }
  depends_on = [yandex_compute_instance.main, yandex_compute_instance.replica]
}
```

---

### for_each-vm.tf

Создание **разных** ВМ main и replica с разной конфигурацией:

```hcl
variable "each_vm" {
  type = list(object({
    vm_name      = string
    cpu          = number
    ram          = number
    disk_volume  = number
  }))
}

locals {
  each_vm_map = { for vm in var.each_vm : vm.vm_name => vm }
}

resource "yandex_compute_instance" "db" {
  for_each = local.each_vm_map
  name     = each.value.vm_name
  ...
}
```

---

### disk_vm.tf

Создание 3 дисков и подключение их к одной ВМ с использованием `dynamic` и `for_each`:

```hcl
resource "yandex_compute_disk" "storage" {
  count = 3
  name  = "disk-${count.index}"
  size  = 1
  ...
}

resource "yandex_compute_instance" "storage" {
  name = "storage"
  ...
  dynamic "secondary_disk" {
    for_each = yandex_compute_disk.storage
    content {
      disk_id = secondary_disk.value.id
    }
  }
}
```

---

### ansible.tf

Генерация ansible-инвентаря с помощью `templatefile`:

```hcl
data "template_file" "inventory" {
  template = file("${path.module}/inventory.tmpl")
  vars = {
    webservers  = yandex_compute_instance.web
    databases   = yandex_compute_instance.db
    storage     = yandex_compute_instance.storage
  }
}

resource "local_file" "inventory" {
  content  = data.template_file.inventory.rendered
  filename = "${path.module}/inventory.ini"
}
```

---

### variables.tf и terraform.tfvars

Переменная для VM:

```hcl
variable "each_vm" {
  type = list(object({
    vm_name      = string
    cpu          = number
    ram          = number
    disk_volume  = number
  }))
}

# terraform.tfvars
each_vm = [
  { vm_name = "main", cpu = 2, ram = 2048, disk_volume = 20 },
  { vm_name = "replica", cpu = 1, ram = 1024, disk_volume = 10 }
]
```

---

## Скриншоты

- **Входящие правила группы безопасности:**

  ![Security group](https://user-images.githubusercontent.com/123456789/sg-screenshot.jpg)

- **Инвентарь Ansible после генерации:**  
  *(inventory.ini)*
  ```ini
  [webservers]
  web-1 ansible_host=XX.XX.XX.XX fqdn=web-1.auto.internal
  web-2 ansible_host=XX.XX.XX.XX fqdn=web-2.auto.internal

  [databases]
  main ansible_host=XX.XX.XX.XX fqdn=main.auto.internal
  replica ansible_host=XX.XX.XX.XX fqdn=replica.auto.internal

  [storage]
  storage ansible_host=XX.XX.XX.XX fqdn=storage.auto.internal
  ```

  ![inventory.ini](https://user-images.githubusercontent.com/123456789/inventory-screenshot.jpg)

---

## Заключение

В рамках задания были:

- Применены ключевые конструкции `count`, `for_each`, `dynamic`, `depends_on`.
- Использованы best practices: параметризация, шаблонизация, структура проекта.
- Реализована логика зависимостей и генерации конфигурации для Ansible.
- Применена функция `file()` для SSH-ключей и `templatefile()` для шаблонов.

Все ресурсы были успешно созданы, проверены и **удалены** по завершении работы.

---
